<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Malware Lab | Network Security Ninja</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Malware Lab" />
<meta name="author" content="Jeremiah Bess" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense)." />
<meta property="og:description" content="A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense)." />
<link rel="canonical" href="http://localhost:4000/malware-lab/" />
<meta property="og:url" content="http://localhost:4000/malware-lab/" />
<meta property="og:site_name" content="Network Security Ninja" />
<script type="application/ld+json">
{"@type":"WebPage","author":{"@type":"Person","name":"Jeremiah Bess"},"headline":"Malware Lab","description":"A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense).","url":"http://localhost:4000/malware-lab/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Network Security Ninja" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Network Security Ninja</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/malware-lab/">Malware Lab</a><a class="page-link" href="/resources/">Resources</a><a class="page-link" href="/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Malware Lab</h1>
  </header>

  <div class="post-content">
    <p><strong>Updated 11 Mar 2021:</strong> With some changes to the functions in Windows 10, version 2.0 of my LabNet script, and some clarifications suggested, I’ve updated this post to match the new steps.</p>

<p>The blog post that goes along with this can be found <a href="/how-to/2019/08/20/building-a-malware-analysis-lab">here</a>.</p>

<h1 id="logical-diagram">Logical diagram</h1>
<p><img src="/assets/malware-lab.png" alt="My Lab" /></p>

<h1 id="host-machine">Host Machine</h1>
<ol>
  <li>Install Virtualbox
    <ol>
      <li><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></li>
      <li>Open command prompt</li>
      <li><code class="language-plaintext highlighter-rouge">vboxmanage dhcpserver add --netname Lab --ip 10.0.1.1 --netmask 255.255.255.0 --lowerip 10.0.1.2 --upperip 10.0.1.10 --enable</code></li>
    </ol>
  </li>
</ol>

<h1 id="linux-mint-gateway">Linux Mint Gateway</h1>
<p>VM setup:<br />
CPU: 2 cores<br />
RAM: 2 GB<br />
HD: 32 GB<br />
Network: Set up 2 NICs. The first set as NAT, the second as Internal (named Lab)<br />
Enable: Shared Clipboard, Drag and Drop</p>

<ol>
  <li>Install Linux Mint and all updates
    <ol>
      <li>Download and install <a href="https://linuxmint.com/download.php">https://linuxmint.com/download.php</a>
        <ul>
          <li>When creating the user account, select to Log in automatically</li>
        </ul>
      </li>
      <li>Once installed and running, open a terminal</li>
      <li>Run <code class="language-plaintext highlighter-rouge">sudo apt update &amp;&amp; sudo apt upgrade</code></li>
      <li>Click the Linux Mint start menu, and type Screensaver</li>
      <li>Change “Delay before starting screensaver” to Never</li>
      <li>Reboot</li>
    </ol>
  </li>
  <li>Virtualbox Guest Additions
    <ol>
      <li>Virtualbox menu &gt; Devices &gt; “Insert Guest Additions CD image”</li>
      <li>Run the installer</li>
      <li>Virtualbox menu &gt; Optical Drives &gt; Remove disk from virtual drive</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Linux Mint menu &gt; Quit &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Fresh install”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>Install software:
    <ol>
      <li>Tools via APT: <code class="language-plaintext highlighter-rouge">sudo apt install wireshark python3-pip</code>
        <ul>
          <li>Wireshark: Choose yes when asked to allow non-super users capture packets</li>
        </ul>
      </li>
      <li>Oletools: <code class="language-plaintext highlighter-rouge">sudo -H pip3 install oletools</code>
        <ul>
          <li>If there are errors try running first: <code class="language-plaintext highlighter-rouge">sudo -H pip3 install --upgrade setuptools</code></li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Linux Mint menu &gt; Quit &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Software installed”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>LabNet setup
    <ol>
      <li>Follow the setup instructions on <a href="https://github.com/netsecninja/LabNet">https://github.com/netsecninja/LabNet</a></li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Linux Mint menu &gt; Quit &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Baseline”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>Run Labnet and select “Actual Internet” in preparation for setting up the Windows VM</li>
</ol>

<h1 id="windows-10-victim">Windows 10 Victim</h1>
<p>VM setup:<br />
CPU: 2 cores<br />
RAM: 2 GB<br />
HD: 32 GB<br />
Network: Internal (named Lab)<br />
Enable: Shared Clipboard, Drag and Drop</p>

<ol>
  <li>Install Windows 10
    <ol>
      <li><a href="https://www.microsoft.com/en-us/software-download/windows10ISO">https://www.microsoft.com/en-us/software-download/windows10ISO</a></li>
      <li>Download oldest version available (less patches means more vulnerable for testing!)</li>
      <li>Click “I don’t have internet” during the install to bypass having to log in with a Microsoft account</li>
      <li>Set your local timezone</li>
      <li>Install VM Guest tools, then remove tools disk from virtual drive</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Start menu &gt; Power &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Fresh install”</li>
      <li>Start VM again</li>
    </ol>
  </li>
  <li>Disable patches
    <ol>
      <li>Right-click network icon in task tray &gt; Open Network &amp; Internet settings</li>
      <li>Click on “Properties” for Ethernet</li>
      <li>Enabled Metered connection</li>
    </ol>
  </li>
  <li>Set up Networking
    <ol>
      <li>Right-click network icon in tray, Open Network &amp; Internet Settings</li>
      <li>Change adapter options</li>
      <li>Right-click Ethernet &gt; Properties</li>
      <li>Double-click on IPv4</li>
      <li>Set Primary DNS to 1.1.1.1 and Secondary to your Linux Mint Lab IP</li>
      <li>Click Advanced</li>
      <li>Add Default Gateway, enter your Linux Mint Lab IP</li>
      <li>Click OK to close all the screens</li>
    </ol>
  </li>
  <li>Set up Polar Proxy cert
    <ol>
      <li>On Linux Gateway, run labnet and choose “Actual internet with SSL interception”</li>
      <li>On Victim: Open IE, &lt;Linux Mint Lab IP&gt;:10080, and open the downloaded .cer file</li>
      <li>Install the Certificate in “Trusted Root Certificate Authorities” folder</li>
      <li>On Linux Gateway, Use Ctrl-C to stop the SSL interception, run labnet again and choose “Actual internet”</li>
    </ol>
  </li>
  <li>Autologin
    <ol>
      <li>Open IE, go to <a href="https://live.sysinternals.com/Autologon.exe">https://live.sysinternals.com/Autologon.exe</a> and choose Run</li>
      <li>Add the user password, and click Enable</li>
    </ol>
  </li>
  <li>Reboot</li>
  <li>Install <a href="https://notepad-plus-plus.org/download/">Notepad++</a></li>
  <li>Install <a href="https://www.7-zip.org/download.html">7-zip</a></li>
  <li>Install <a href="https://github.com/netsecninja/SysmonInstaller/archive/master.zip">Sysmon</a>
    <ol>
      <li>Download files to Victim and unzip</li>
      <li>Open PowerShell as an Admin, change into unzipped directory</li>
      <li>Run <code class="language-plaintext highlighter-rouge">set-executionpolicy bypass</code></li>
      <li>Run <code class="language-plaintext highlighter-rouge">./install_sysmon.ps1</code></li>
      <li>Open Event Viewer &gt; right-click on any folder &gt; “Create Custom View”</li>
      <li>For the By Log - Event Logs dropdown, enter “Microsoft-Windows-Sysmon/Operational”, and click OK</li>
      <li>Name it Sysmon, and click OK</li>
    </ol>
  </li>
  <li>Install <a href="https://www.wireshark.org/#download">Wireshark</a></li>
  <li>Download <a href="https://live.sysinternals.com/Procmon.exe">Procmon</a>
    <ol>
      <li>Create a “Tools” folder on your Desktop, save Procmon in there</li>
      <li>Run Procmon</li>
      <li>Options &gt; Disable “Show Resolved Network Addresses”</li>
      <li>Options &gt; Select columns &gt; Add “Thread ID”</li>
      <li>Close Procmon</li>
    </ol>
  </li>
  <li>Install <a href="http://www.graphviz.org/download/">Graphviz</a> (Prereq for ProcDOT)
    <ol>
      <li>During install, select “Add Graphviz to the system PATH for all users”</li>
    </ol>
  </li>
  <li>Install <a href="https://www.winpcap.org/install/default.htm">Winpcap</a> (Prereq for ProcDOT)</li>
  <li>Download <a href="https://www.winpcap.org/windump/install/default.htm">Windump</a> (Prereq for ProcDOT)
    <ol>
      <li>Save in your Tools folder</li>
    </ol>
  </li>
  <li>Install <a href="http://procdot.com/downloadprocdotbinaries.htm">ProcDOT</a>
    <ol>
      <li>Unzip in your Tools folder</li>
      <li>Zip password: procdot</li>
      <li>Navigate to Tools\Procdot\win64, and run procdot.exe</li>
      <li>Set WinDump path</li>
      <li>Set Graphviz dot.exe path (C:\Program Files\Graphviz\bin\dot.exe)</li>
      <li>Close ProcDOT</li>
    </ol>
  </li>
  <li>Install Office or <a href="https://www.libreoffice.org/download/download/">LibreOffice</a></li>
  <li>Install <a href="https://www.python.org/downloads/windows/">Python</a>
    <ol>
      <li>Make sure to check the “Add Python to Path” box during install</li>
    </ol>
  </li>
  <li>Install OLETools
    <ol>
      <li>Open a Command prompt as admin and run <code class="language-plaintext highlighter-rouge">pip install oletools</code></li>
    </ol>
  </li>
  <li>Disable sleep
    <ol>
      <li>Start &gt; Power &amp; sleep settings</li>
      <li>Under Screen change both Battery and Plugged In to Never</li>
    </ol>
  </li>
  <li>Create shortcuts in Tools folder for:
    <ol>
      <li>Wireshark (C:\Program Files\Wireshark\wireshark.exe)</li>
      <li>Procdot.exe (Tools\Procdot\win64\procdot.exe)</li>
      <li>Event Viewer (Start &gt; Event Viewer &gt; Open File Location &gt; COPY the shortcut)</li>
    </ol>
  </li>
  <li>Snapshot
    <ol>
      <li>Start menu &gt; Power &gt; Shutdown</li>
      <li>Virtualbox &gt; Snapshot named “Baseline”</li>
    </ol>
  </li>
</ol>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Network Security Ninja</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jeremiah Bess</li><li><a class="u-email" href="mailto:jeremiah.bess@gmail.com">jeremiah.bess@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/netsecninja"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">netsecninja</span></a></li><li><a href="https://www.linkedin.com/in/jeremiahbess"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">jeremiahbess</span></a></li><li><a href="https://www.twitter.com/netsecninja"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">netsecninja</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A blog to post my Tactics, Techniques, and Procedures (TTPs) as a card-carrying member of the Blue Team (Cyber Defense). </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
