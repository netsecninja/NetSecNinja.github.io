---
layout: page
title: Malware Lab
permalink: /malware-lab/
---

The blog post that goes along with this can be found [here](/how-to/2019/08/20/building-a-malware-analysis-lab).

# Logical diagram
![My Lab](/assets/malware-lab.png)

# Host Machine
1. Install Virtualbox
    1. <https://www.virtualbox.org/wiki/Downloads>
    2. Open command prompt
    3. ```vboxmanage dhcpserver add --netname Lab --ip 10.0.1.1 --netmask 255.255.255.0 --lowerip 10.0.1.2 --upperip 10.0.1.10 --enable```

# Linux Mint Gateway
VM setup:  
CPU: 2 cores  
RAM: 2 GB  
HD: 32 GB  
Network: Set up 2 NICs. One set as NAT, the other as Internal (named Lab)

1. Install Linux Mint and all updates
    1. Download and install <https://linuxmint.com/download.php>
    2. Once installed and running, open command the prompt
    3. ```sudo apt update && sudo apt upgrade```
2. Virtualbox Guest Additions
    1. Virtualbox menu > Devices > "Insert Guest Additions CD image"
    2. Run installer
    3. Virtualbox menu > Optical Drives > Remove disk from virtual drive
3. Snapshot
    1. Linux Mint menu > Quit > Shutdown
    2. Virtualbox > Snapshot named "Fresh install"
    3. Start VM again
4. Install software:
    1. Wireshark:```sudo apt install wireshark```
        1. Choose yes when asked to allow non-super users capture packets
    2. PIP:```sudo apt install python3-pip```
    3. Oletools:```sudo -H pip3 install oletools```
        * If there are errors try running first:```sudo -H pip3 install --upgrade setuptools```
    4. InetSim:```sudo apt install inetsim```
5. Polar Proxy
    1. ```mkdir ~/PolarProxy```
    2. ```cd ~/PolarProxy/```
    3. ```curl https://www.netresec.com/?Download=PolarProxy | tar -xzvf -```
    4. ```cd ~```
6. LabNet setup
    1. Follow the setup instructions on <https://github.com/netsecninja/LabNet>
        * Note: the labnet.sh file should be in ~ (root of your user profile)
7. Note IP address of Internal NIC: ```ip a```
    1. If the IP isn't 10.0.1.2, just make corrections below to the IP listed.
8. Snapshot
    1. Linux Mint menu > Quit > Shutdown
    2. Virtualbox > Snapshot named "Baseline"
    3. Start VM again

# Windows 10 Victim
VM setup:  
CPU: 2 cores  
RAM: 2 GB  
HD: 32 GB  
Network: Internal (named Lab)

1. Install Windows 10
    1. <https://www.microsoft.com/en-us/software-download/windows10ISO>
    2. Download oldest version available (less patches means more vulnerable for testing!)
    3. Skip network connection (avoids having to log in with a Microsoft account)
2. Snapshot
    1. Start menu > Power > Shutdown
    2. Virtualbox > Snapshot named "Fresh install"
    3. Start VM again 
3. Disable patches
    1. Right-click network icon in task tray > Open Network & Internet settings
    2. Change connection properties
    3. Enabled Metered connection
4. Set up Networking
    1. Right-click network icon in tray, Open Network & Internet Settings
    2. Change adapter options
    3. Right-click NIC, Properties
    4. Double-click on IPv4
    5. Set DNS to 1.1.1.1 and Linux Mint Internal IP (10.0.1.2)
    6. Click Advanced
    7. Add Default Gateway, Linux Mint Internal IP (10.0.1.2)
    8. Click OK to close all the screens
5. Set up Polar Proxy cert
    1. On Linux Gateway: sudo ./labnet.sh polar
    2. On Victim: Open IE, 10.0.1.2:10080, open .cer file
    3. Install .cer Certificate in Local Machine's trusted root certificates folder
6. Autologin
    1. Start > Netplwiz
    2. Click user, uncheck “Users must enter a user name and password to use this computer”
    3. Apply, enter password
7. Disable AV
    1. Open Command Prompt as Admin
    2. ```reg.exe ADD "HKLM\Software\Policies\Microsoft\Windows Defender" /t REG_DWORD /v DisableAntiSpyware /d 1```
8. Install Guest tools
9. Reboot
10. Install [Notepad++](https://notepad-plus-plus.org/download/)
11. Install [Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)
    1. Download the [SwiftOnSecurity policy](https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml)
    2. Start > CMD > Run as Administrator
    3. CD into sysmon directory
    4. ```sysmon.exe -accepteula -i sysmonconfig-export.xml```
    5. Start > Event Viewer
    6. Right-click Custom View > Create Custom View
    7. Event Logs > Application and Services Logs > Microsoft > Windows > Sysmon
    8. Click Ok, name Sysmon
12. Install [Wireshark](https://www.wireshark.org/#download)
13. Install [Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)
    1. Options > Disable “Show Resolved Network Addresses”
    2. Options > Select columns > Add “Thread ID”
14. Install [Graphviz](http://www.graphviz.org/download/)
15. Install [Winpcap](https://www.winpcap.org/install/default.htm)
16. Download [Windump](https://www.winpcap.org/windump/install/default.htm)
17. Install [ProcDOT](http://procdot.com/downloadprocdotbinaries.htm)
    1. Zip password: procdot
    2. Set WinDump path
    3. Set Graphviz dot.exe path (C:\Program Files(x86)\Graphviz#.##\bin\dot.exe)
18. Install Office or [LibreOffice](https://www.libreoffice.org/download/download/)
19. Install [Python](https://www.python.org/downloads/windows/)
    1. Make sure to check the "Add Python to Path" box during install
    2. Make sure "pip" is set to installed, which it is by default
20. Install OLETools
    1. Command prompt > ```pip install oletools```
21. Disable sleep under power settings
22. Create a Tools folder on Desktop, put shortcuts for:
    1. Wireshark
    2. Procmon
    3. ProcDOT
    4. Event Viewer
23. Snapshot
    1. Start menu > Power > Shutdown
    2. Virtualbox > Snapshot named "Baseline"

